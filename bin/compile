#!/usr/bin/env bash

# set -e            # fail fast
# set -o pipefail   # don't ignore exit codes when piping output
# set -x          # enable debugging

# Configure directories
build_dir=$1
cache_dir=$2
env_dir=$3

bp_dir=$(cd $(dirname $0); cd ..; pwd)

source $bp_dir/bin/common.sh

# export LDFLAGS=-L$build_dir/vendor/lib
# export LD_LIBRARY_PATH=$build_dir/vendor/lib

download () {
  status "Downloading and installing wkhtmltopdf"
  wkhtmltopdf_url="https://codeload.github.com/wkhtmltopdf/wkhtmltopdf/tar.gz/0.12.1"
  curl $wkhtmltopdf_url -s -o - | tar xzvf - -C $build_dir
}

install () {
	if [ -f $build_dir/vendor/wkhtmltopdf ]; then
	  exit 0
	else
	  download
  	  mkdir -p $build_dir/vendor/bin
	  mv $build_dir/0.12.1 $build_dir/vendor/wkhtmltopdf
	  cd $build_dir/vendor/wkhtmltopdf
	  status "Configuring wkhtmltopdf"
	  ./configure   >/dev/null 2>&1
	  status "Make!"
	  make  >/dev/null 2>&1
	  status "Make install !!!"
	  make install  >/dev/null 2>&1
	fi
}


install

status "Writing profile script"
mkdir -p $build_dir/.profile.d
cat <<EOF >$build_dir/.profile.d/000_wkhtmltopdf.sh
export PATH="\$HOME/vendor/bin$PATH"
export LD_LIBRARY_PATH="\$HOME/vendor/lib:\$LD_LIBRARY_PATH"
export INCLUDE_PATH="\$HOME/vendor/include:\$INCLUDE_PATH"
export CPATH="\$INCLUDE_PATH"
export CPPPATH="\$INCLUDE_PATH"
EOF

exit 0